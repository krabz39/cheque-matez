<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Merchant Dashboard - Cheque Matez</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.socket.io/4.7.1/socket.io.min.js"></script>
<style>
  body { font-family:'Segoe UI', Tahoma, sans-serif; background:#f8f9fa; }
  .navbar { background:#063d3f; }
  .navbar-brand, .navbar-nav .nav-link { color:#fff !important; }
  .card { border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1); margin-bottom:20px; }
  h2, h3 { color:#063d3f; }
  .section-outline { border:2px dashed #063d3f; border-radius:12px; padding:15px; margin-bottom:20px; background: #f0fdfd; position:relative; }
  .section-label { position:absolute; top:-12px; left:15px; background:#f0fdfd; padding:0 8px; font-weight:bold; color:#063d3f; }
</style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="#">Cheque Matez</a>
    <div class="ms-auto d-flex align-items-center">
      <span class="text-white me-3">Merchant: {{ session['merchant_name'] }}</span>
      <a class="btn btn-outline-light btn-sm" href="{{ url_for('logout') }}">Logout</a>
    </div>
  </div>
</nav>

<div class="container-fluid mt-4">
  <div class="row">

    <!-- Sidebar -->
    <div class="col-md-2 mb-4">
      <div class="list-group">
        <a href="#" class="list-group-item list-group-item-action active">Dashboard</a>
        <a href="#" class="list-group-item list-group-item-action">Transactions</a>
        <a href="#" class="list-group-item list-group-item-action">Settlements</a>
        <a href="#" class="list-group-item list-group-item-action">API Keys</a>
        <a href="#" class="list-group-item list-group-item-action">Settings</a>
      </div>
    </div>

    <!-- Main Content -->
    <div class="col-md-10">

      <!-- Overview Cards -->
      <div class="section-outline">
        <div class="section-label">Overview Cards</div>
        <div class="row mb-4">
          <div class="col-md-4">
            <div class="card text-white bg-success">
              <div class="card-body">
                <h5 class="card-title">Today's Payments</h5>
                <p class="card-text fs-4" id="todaysPayments">KES 0</p>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card text-white bg-primary">
              <div class="card-body">
                <h5 class="card-title">Pending Settlements</h5>
                <p class="card-text fs-4" id="pendingSettlements">KES 0</p>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card text-white bg-warning">
              <div class="card-body">
                <h5 class="card-title">Total Volume</h5>
                <p class="card-text fs-4" id="totalVolume">KES 0</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Transaction Chart -->
      <div class="section-outline">
        <div class="section-label">Transaction Volume Chart</div>
        <div class="card mb-4">
          <div class="card-header fw-bold">Transaction Volume (Last 7 Days)</div>
          <div class="card-body">
            <canvas id="txnChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Transactions Table -->
      <div class="section-outline">
        <div class="section-label">Recent Transactions</div>
        <div class="card mb-4">
          <div class="card-body">

            <!-- Filter/Search/Export -->
            <div class="mb-3 row">
              <div class="col-md-2">
                <label class="form-label">Client Name</label>
                <input type="text" id="searchClient" class="form-control" placeholder="Search Client">
              </div>
              <div class="col-md-2">
                <label class="form-label">Status</label>
                <select id="filterStatus" class="form-select">
                  <option value="all" selected>All</option>
                  <option value="Success">Success</option>
                  <option value="Pending">Pending</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label">Date</label>
                <input type="date" id="filterDate" class="form-control">
              </div>
              <div class="col-md-2 d-flex align-items-end">
                <button class="btn btn-primary me-2" id="applyFilter">Filter</button>
                <button class="btn btn-secondary" id="resetFilter">Reset</button>
              </div>
              <div class="col-md-2 d-flex align-items-end">
                <button class="btn btn-success" id="exportCSV">Export CSV</button>
              </div>
            </div>

            <table class="table table-hover" id="transactionsTable">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Client</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Payout Account</th>
                  <th>Method</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>

          </div>
        </div>
      </div>

      <!-- API Keys -->
      <div class="section-outline">
        <div class="section-label">API Keys</div>
        <div class="card mb-4">
          <div class="card-body">
            <p><strong>Public Key:</strong> <span id="publicKey">{{ session['public_key'] }}</span></p>
            <p><strong>Secret Key:</strong> <span id="secretKey">{{ session['secret_key'] }}</span></p>
            <button class="btn btn-sm btn-outline-primary">Regenerate Keys</button>
          </div>
        </div>
      </div>

      <!-- Settings -->
      <div class="section-outline">
        <div class="section-label">Settings</div>
        <div class="card mb-5">
          <div class="card-body">
           <form method="POST" action="{{ url_for('merchant') }}">

              <div class="mb-3">
                <label class="form-label">Business Name</label>
                <input type="text" class="form-control" name="business_name" value="{{ session['merchant_name'] }}">
              </div>
              <div class="mb-3">
               <div class="mb-3">
  <label class="form-label">Designated Payout Account</label>

  <!-- Service selection -->
  <select id="payoutMethod" class="form-select mb-2">
    <option value="mpesa" selected>Mpesa</option>
    <option value="bank">Bank</option>
  </select>

  <!-- Input for Mpesa phone or bank account -->
  <input type="text" id="payoutInput" class="form-control mb-2" placeholder="254712345678" value="{{ session['payout_account'] }}">

  <!-- Bank selection -->
  <div id="bankDiv" style="display:none;">
    <select id="bankSelect" class="form-select mb-2">
      <option value="">--Select Bank--</option>
      <option>African Banking Corporation Ltd</option>
      <option>ABC Bank</option>
      <option>Absa Bank Kenya (Barclays)</option>
      <option>Bank of Africa Kenya</option>
      <option>Citibank Kenya</option>
      <option>Consolidated Bank</option>
      <option>Co-operative Bank of Kenya</option>
      <option>Credit Bank</option>
      <option>Diamond Trust Bank (DTB)</option>
      <option>Ecobank Kenya</option>
      <option>Equity Bank</option>
      <option>Family Bank</option>
      <option>First Community Bank</option>
      <option>Guardian Bank</option>
      <option>Habib Bank AG Zurich</option>
      <option>HFC Bank</option>
      <option>I&M Bank</option>
      <option>KCB Bank</option>
      <option>Middle East Bank</option>
      <option>NCBA Bank</option>
      <option>National Bank of Kenya</option>
      <option>Prime Bank</option>
      <option>SBG Bank Kenya</option>
      <option>Standard Chartered Bank</option>
      <option>Sidian Bank</option>
      <option>Stanbic Bank</option>
      <option>Uchumi Commercial Bank</option>
      <option>Victoria Commercial Bank</option>
    </select>
    <div id="paybillDisplay" style="font-weight:bold; margin-top:5px;"></div>
    <input type="hidden" id="paybillInput" name="paybill_account">
  </div>
</div>

<script>
// Bank paybill mapping
const bankPaybills = {
  "African Banking Corporation Ltd":"982800","ABC Bank":"982801","Absa Bank Kenya (Barclays)":"303030",
  "Bank of Africa Kenya":"972900","Citibank Kenya":"700100","Consolidated Bank":"920200",
  "Co-operative Bank of Kenya":"900900","Credit Bank":"970970","Diamond Trust Bank (DTB)":"222222",
  "Ecobank Kenya":"961961","Equity Bank":"247247","Family Bank":"222111","First Community Bank":"955955",
  "Guardian Bank":"955000","Habib Bank AG Zurich":"908908","HFC Bank":"996996","I&M Bank":"989898",
  "KCB Bank":"522522","Middle East Bank":"999000","NCBA Bank":"522522","National Bank of Kenya":"990990",
  "Prime Bank":"993993","SBG Bank Kenya":"666333","Standard Chartered Bank":"600100","Sidian Bank":"905905",
  "Stanbic Bank":"606606","Uchumi Commercial Bank":"990100","Victoria Commercial Bank":"988988"
};

const payoutMethod = document.getElementById("payoutMethod");
const payoutInput = document.getElementById("payoutInput");
const bankDiv = document.getElementById("bankDiv");
const bankSelect = document.getElementById("bankSelect");
const paybillDisplay = document.getElementById("paybillDisplay");
const paybillInput = document.getElementById("paybillInput");

// Show/hide bank input
payoutMethod.addEventListener("change", ()=>{
  if(payoutMethod.value==="mpesa"){
    payoutInput.placeholder="254712345678";
    payoutInput.value="{{ session['payout_account'] }}";
    bankDiv.style.display="none";
    paybillDisplay.textContent="";
    paybillInput.value="";
  } else {
    payoutInput.placeholder="Enter account number";
    payoutInput.value="";
    bankDiv.style.display="block";
    const selectedBank = bankSelect.value;
    if(bankPaybills[selectedBank]){
      paybillDisplay.textContent="Paybill: "+bankPaybills[selectedBank];
      paybillInput.value=bankPaybills[selectedBank];
    }
  }
});

// Update paybill when bank changes
bankSelect.addEventListener("change", ()=>{
  const selectedBank = bankSelect.value;
  if(bankPaybills[selectedBank]){
    paybillDisplay.textContent="Paybill: "+bankPaybills[selectedBank];
    paybillInput.value=bankPaybills[selectedBank];
  } else {
    paybillDisplay.textContent="";
    paybillInput.value="";
  }
});
</script>

              </div>
              <button type="submit" class="btn btn-success">Save Changes</button>
            </form>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:11">
  <div id="paymentToast" class="toast align-items-center text-white bg-success border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body" id="toastBody">New Payment Received!</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ------------------------
// Transactions / Chart
// ------------------------
const merchantId = "{{ session['merchant_email'] }}";

const ctx = document.getElementById('txnChart').getContext('2d');
const txnChart = new Chart(ctx, {
  type: 'line',
  data: { labels:['Mon','Tue','Wed','Thu','Fri','Sat','Sun'], datasets:[{
    label: 'Transaction Volume (KES)',
    data: [0,0,0,0,0,0,0],
    fill: true,
    borderColor: '#0d6efd',
    backgroundColor: 'rgba(13,110,253,0.2)',
    tension: 0.3
  }]},
  options: { responsive:true }
});

let transactions = [];
const toastEl = document.getElementById('paymentToast');
const toast = new bootstrap.Toast(toastEl);

// Fetch merchant transactions
async function loadTransactions() {
  try {
    const res = await fetch(`/api/merchant/${merchantId}/transactions`);
    const data = await res.json();
    transactions = data.transactions;
    applyFilter();
    updateOverviewChart();
  } catch(err){ console.error(err); }
}

// Update overview cards & chart
function updateOverviewChart() {
  const today = new Date().toISOString().split('T')[0];
  const todays = transactions.filter(t=>t.date===today).reduce((a,b)=>a+b.amount,0);
  const pending = transactions.filter(t=>t.status==='Pending').reduce((a,b)=>a+b.amount,0);
  const total = transactions.reduce((a,b)=>a+b.amount,0);
  document.getElementById('todaysPayments').textContent = `KES ${todays.toLocaleString()}`;
  document.getElementById('pendingSettlements').textContent = `KES ${pending.toLocaleString()}`;
  document.getElementById('totalVolume').textContent = `KES ${total.toLocaleString()}`;

  const last7 = Array(7).fill(0);
  transactions.forEach(t=>{
    const day = new Date(t.date).getDay();
    last7[day===0?6:day-1]+=t.amount;
  });
  txnChart.data.datasets[0].data = last7;
  txnChart.update();
}

// Filter/Search
function applyFilter() {
  const statusFilter = document.getElementById('filterStatus').value;
  const dateFilter = document.getElementById('filterDate').value;
  const searchTerm = document.getElementById('searchClient').value.toLowerCase();
  const tbody = document.querySelector('#transactionsTable tbody');
  tbody.innerHTML = '';
  transactions.forEach(txn => {
    if ((statusFilter==='all'||txn.status===statusFilter) &&
        (!dateFilter||txn.date===dateFilter) &&
        txn.client.toLowerCase().includes(searchTerm)) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${txn.date}</td><td>${txn.client}</td><td>${txn.amount.toLocaleString()}</td>
                      <td>${txn.status}</td><td>${txn.account}</td><td>${txn.method}</td>`;
      tbody.appendChild(tr);

      if(txn.status==='Success'){ 
        document.getElementById('toastBody').textContent=`New Payment: KES ${txn.amount.toLocaleString()} from ${txn.client}`;
        toast.show();
      }
    }
  });
}

document.getElementById('applyFilter').addEventListener('click', applyFilter);
document.getElementById('resetFilter').addEventListener('click', ()=>{
  document.getElementById('filterStatus').value='all';
  document.getElementById('filterDate').value='';
  document.getElementById('searchClient').value='';
  applyFilter();
});

// CSV Export
document.getElementById('exportCSV').addEventListener('click', ()=>{
  let csv='Date,Client,Amount,Status,Account,Method\n';
  transactions.forEach(t=>{ csv+=`${t.date},${t.client},${t.amount},${t.status},${t.account},${t.method}\n`; });
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'transactions.csv';
  a.click();
});

// Real-Time WebSocket Updates (Socket.IO)
const socket = io();
socket.on(`merchant_${merchantId}_new_txn`, txn=>{
  transactions.push(txn);
  applyFilter();
  updateOverviewChart();
  document.getElementById('toastBody').textContent=`New Payment: KES ${txn.amount.toLocaleString()} from ${txn.client}`;
  toast.show();
});

window.addEventListener('load', loadTransactions);
</script>

</body>
</html>
